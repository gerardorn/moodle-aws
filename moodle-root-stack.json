{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Kavak Moodle Main Stack",
  "Parameters":{
    "DbMasterUsername":{
      "Type":"String",
      "Description":"The master username for the database",
      "Default":"root"
    },
    "DomainName":{
      "Type":"String",
      "Description":"Domain name to be used by CloudFront",
      "Default":""
    },
    "DomainFlag":{
      "Type":"String",
      "Default":"false",
      "AllowedValues":[
        "false",
        "true"
      ],
      "Description":"Indicates if a domain name should be attached to the CloudFront distribution"
    },
    "InstanceKeyName":{
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Description":"Name of an existing EC2 KeyPair to enable SSH access to the instance"
    }
  },
  "Conditions":{
    "DomainUsateTrue":{
      "Fn::Equals":[
        {
          "Ref":"DomainFlag"
        },
        "true"
      ]
    },
    "DomainUsageFalse":{
      "Fn::Equals":[
        {
          "Ref":"DomainFlag"
        },
        "false"
      ]
    }
  },
  "Resources":{
    "AssetsBucket":{
      "Type":"AWS::S3::Bucket",
      "Properties":{
        "BucketName":{
          "Fn::Join":[
            "-",
            [
              {
                "Ref":"AWS::StackName"
              },
              "assets"
            ]
          ]
        },
        "PublicAccessBlockConfiguration":{
          "BlockPublicAcls":"false",
          "BlockPublicPolicy":"false",
          "RestrictPublicBuckets":"false"
        }
      }
    },
    "NetworkingStack":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "TemplateURL":"networking/networking-stack.json"
      }
    },
    "SecurityStack":{
      "Type":"AWS::CloudFormation::Stack",
      "DependsOn":[
        "NetworkingStack"
      ],
      "Properties":{
        "Parameters":{
          "DbMasterUsername":{
            "Ref":"DbMasterUsername"
          },
          "VpcId":{
            "Fn::GetAtt":[
              "NetworkingStack",
              "Outputs.VpcId"
            ]
          },
          "DomainName":{
            "Ref":"DomainName"
          },
          "DomainFlag":{
            "Ref":"DomainFlag"
          }
        },
        "TemplateURL":"security/security-stack.json"
      }
    },
    "DataStack":{
      "Type":"AWS::CloudFormation::Stack",
      "DependsOn":[
        "SecurityStack"
      ],
      "Properties":{
        "Parameters":{
          "DbSecretId":{
            "Fn::GetAtt":[
              "SecurityStack",
              "Outputs.DbSecretId"
            ]
          },
          "DbSubnetGroupName":{
            "Fn::GetAtt":[
              "NetworkingStack",
              "Outputs.DbSubnetGroupName"
            ]
          }
        },
        "TemplateURL":"data/data-stack.json"
      }
    }
  }
}
